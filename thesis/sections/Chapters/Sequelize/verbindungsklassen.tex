\hfour{Verbindungsklassen für die Datenbank}

Die Verbindungsklassen sind für die Kommunikation mit der Datenbank und deren unterschiedlichen Tabellen zuständig. Nach einem gewissen Initialisierungsprozess, welcher später beschrieben wird, folgen am Ende der Klasse Methoden. Diese Methoden sind für den Zugriff nach verschiedenen Kriterien zuständig (Daten nach einem gewissen Parameter auslesen, oder alle Daten auslesen). Im Projekt ZELIA gibt es Vier unterschiedliche Arten von Zugriffsmethoden auf die Datenbank.

\begin{itemize}
    \item Das Auslesen aller Daten
    \item Das Auslesen von Daten nach gewissen Kriterien (zum Beispiel nach mitgegebener Raumnummer)
    \item Das Verändern von vorhandenen Datensätzen in der Datenbank
    \item Das hinzufügen von Datensätzen in die Datenbank
\end{itemize}

Um die Struktur einer Verbindungsklasse besser zu verstehen, kann man sich das Klasse "RoomReportConnection" ansehen.

Zu Beginn muss man aus der Sequelize-Bibliothek "Models" und "DataTypes" importieren. Folgender Code ist dafür zuständig:

\typescript{code/Sequelize/importVerbindung.ts}{Importieren von "Models" und "DataTypes"}

Im zweiten Schritt werden diverseste Datentypen aus ZELIA in die Klasse importiert, welche in weiteren Schritten benötigt werden.

In weiterer Folge müssen nun die Werte, welche in der Tabelle auf die zugegriffen werden soll definiert werden. Hierzu erstellt man eine neue Klasse, welche das "RoomReportEntity" Interface beinhaltet und implementiert. In dieser Klasse werden nun die Spalten Eigenschaften mit Zugriffsoperatoren und Datentypen versehen. Außerdem werden an alle Eigenschaften außer "Id" ein "!" angehängt. Dieses gibt da, dass es sich um ein Pflichtfeld handelt. Bei der "Id" steht ein "?". Dieses steht für eine nicht zwangläufig auszufüllende Eigenschaft.

\typescript{code/Sequelize/class.ts}{Klasse "RoomReport"}

Diese Klasse, welche das "Entityinterface" nun implementiert muss nun nach den Sequelizestandard initialisiert werden. Hierbei wird auf die gewünschte Klasse die von Sequelize zur Verfügung gestellte Methode "init" angewandt. Nachfolgend wird nun jeder Eigenschaft aus der Klasse (in diesem Fall RoomReport) mehrere Attribute mitgegeben (zum Beispiel ein "type" oder "allow null").

Außerdem werden Eigenschaften, welche in der Datenbank über einen Fremdschlüssel referenziert werden mit dem Schlüsselwort "references" auf eine Spalte einer anderen Tabelle referenziert. Hierbei muss nachher noch das "Model" angegeben werden auf welches Bezug genommen wird und der Schlüssel, welcher referenziert werden soll.

Zum Schluss wird noch der Name der Tabelle angegeben, auf welche Bezug genommen wird und das Sequelizeobjekt wird mitgegeben.

\typescript{code/Sequelize/init.ts}{Initialisierung einer Zugriffsklasse auf die Datenbank}

Der Prozess zum Setzten eines Fremdschlüssels ist jedoch noch nicht abgeschlossen, da man angeben muss, dass die Tabelle auf die referenziert wird viele unserer Objekte beinhalten. Umgekehrt aber nur eines der anderen Objekte auf unseres zutrifft. Im vorliegenden Beispiel bedeutet das: Ein "Room" kann mehrere "RoomReports" beinhalten. Ein "RoomReport" ist aber immer einem gewissen "Room" zugeordnet.

\typescript{code/Sequelize/fremdSchluessel.ts}{Finalisieren einer Fremdbeziehung zwischen Zwei Tabellen}

Bei den tatsächlichen Zugriffsmethoden gibt es wie oben schon erwähnt 4 unterschiedliche Arten

\hfive{Auslesen aller Datensätze}

Mit dieser Methode werden alle Datensätze einer Tabelle ausgelesen und in eine Konstante gespeichert. Dies ist beispielsweise für die Administrator*innen relevant, da diese eine Übersicht aller Meldungen für alle Räume benötigen um zu sehen, wie viele Schäden noch offen sind und welche schon abgearbeitet sind.

Hierbei ist es auch nicht erforderlich, dass der Server eine Raumnummer als Parameter mitgibt. Die von Sequelize implementierte Methode "findAll" greift dann auf die Tabelle zu. Diese kann jedoch auch mit mehreren Attributen versehen werden. Als Beispiel kann das nicht zurückliefern von bestimmten Spalten nennen. Sollte ein Fremdschlüssel gesetzt sein, was in diesem Beispiel der Fall ist, ist es außerdem notwendig das "Model" der zu referenzierenden Tabelle anzugeben und die Eigenschaft "required" auf "true" zu setzten. Zum Schluss wird die Konstante mit den Werten zurückgegeben.

\typescript{code/Sequelize/getAll.ts}{Zurückliefern aller Datensätze der Tabelle "RoomeReport"}

\hfive{Auslesen von Datensätzen nach Raumnummer gefiltert}

Mit dieser Methode werden nur einzelne Datensätze für einen bestimmten Raum ausgelesen. Dies ist beispielsweise für das hinzufügen von Warnungen vor Schäden zu einem Raum relevant. 

Die Struktur ist der Methode zum Auslesen aller "RoomReports" ähnlich, jedoch mit dem Unterschied, dass ein Parameter mit der Raumnummer mitgegeben werden muss. Nun wird als zusätzliches Attribut ein "where" hinzugefügt um die Datensätze nach einer gewissen Raumnummer zu filtern.

\typescript{code/Sequelize/getRoomNumber.ts}{Auslesen von bestimmten Datensätzen (nach Raumnummer gefiltert)}

\hfive{Verändern von vorhandenen Datensätzen}

Gerade beim Melden von Schäden in Räumen ist es wichtig, Datensätze welche schon vorhanden sind wieder zu verändern, da beim Eintrag in die Datenbank der Status einer Meldung darauf eingestellt ist, dass er noch nicht in Arbeit ist. Sobald er in Arbeit ist, kann eine Administrator*in den Status auf "in Arbeit" ändern, damit die Schüler*innen erkennen, dass sich um ihr gemeldetes Problem gekümmert wird. Zum Abschluss wird der Status auf "Erledigt" gesetzt.

Hierbei müssen Zwei Parameter mitgegeben werden, nämlich einerseits die "id" des Datensatzes als Zahl und der neue "ReportStatus" als Text. Nun kann mit der von Sequelize bereitgestellten Methode "update" der Datensatz verändert werden. Hierbei muss zuerst der Spaltenname und der neue Status, welcher als Parameter mitgegeben wurde angegeben werden und nachher mit einem "where" der richtige Datensatz anhand der mitgegebenen "id" gefunden werden.

\typescript{code/Sequelize/change.ts}{Ändern der Spalte "ReportDescription" in der Tabelle "RoomReport"}

\hfive{Hinzufügen von Datensätzen}

Wenn nun von einer Person, welche sich im Schulgebäude aufhält ein Schaden in einem Raum entdeckt wird bietet ZELIA dich Möglichkeit diesen zu melden. Der neu gemeldete Schaden muss dann in der Datenbank gespeichert werden können um später darauf zugreifen zu können und ihn als verantwortliche Person bearbeiten zu können.

Sequelize stellt zum Schrieben in eine Tabelle die Methode "create" zur Verfügung, welche direkt auf das "Model" angewandt werden kann. Nachfolgend muss jeder Spalte ein Wert zugeordnet werden. Die Daten hierfür werden in dem Beispiel aus dem mitgegebenen "RoomReport" Objekt entnommen.

\typescript{code/Sequelize/new.ts}{Hinzufügen eines neuen Datensatzes}
